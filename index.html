<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>USV St. Marein U14 â€“ Turnierplan</title>

<style>
:root{
  --bg:#f5f5f5;
  --card:#ffffff;
  --text:#1f2a37;
  --muted:#6b7280;
  --primary:#1b4b8f;
  --primary2:#2f6ed1;
  --danger:#c0392b;
  --line:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* INTRO */
#intro{
  position:fixed; inset:0;
  background:#000;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  z-index:9999;
  animation:introFade 6s ease-out forwards;
}
#intro img{
  width:70%; max-width:420px;
  opacity:0;
  animation:ballIn 2.5s ease-out forwards .3s;
}
#introText{
  margin-top:18px;
  color:#fff;
  font-size:2.0rem;
  font-weight:900;
  opacity:0;
  text-align:center;
  text-shadow:0 0 12px rgba(255,255,255,.7);
  animation:textIn 2.5s ease-out forwards 1.1s;
}
@keyframes ballIn{0%{opacity:0;transform:scale(.95)}100%{opacity:1;transform:scale(1)}}
@keyframes textIn{0%{opacity:0;transform:translateY(14px)}100%{opacity:1;transform:translateY(0)}}
@keyframes introFade{0%{opacity:1}100%{opacity:0;visibility:hidden}}
#main{opacity:0;display:none;transition:opacity 1.2s ease}

/* HEADER */
header{background:var(--primary);color:#fff;padding:18px 16px}
.header-inner{
  max-width:1180px;margin:0 auto;
  display:flex;align-items:center;gap:18px
}
.header-left{min-width:130px}
.logo{
  width:110px;height:110px;border-radius:50%;overflow:hidden;
  animation:logoGlowStrong 3s ease-in-out infinite;
}
.logo img{width:100%;height:100%;object-fit:cover;display:block}
@keyframes logoGlowStrong{
  0%,100%{
    box-shadow:0 0 0 3px rgba(255,255,255,.25), 0 0 10px rgba(255,255,255,.20);
    filter:brightness(1);
  }
  50%{
    box-shadow:0 0 0 3px rgba(255,255,255,.30), 0 0 24px rgba(255,255,255,.85);
    filter:brightness(1.08);
  }
}
.header-center{flex:1;text-align:center}
.header-center h1{margin:0;font-size:2.0rem;font-weight:900}
.header-center p{margin:8px 0 0;opacity:.95;font-size:1.0rem}
.header-right{min-width:240px;display:flex;justify-content:flex-end}
.header-photo{
  width:230px;height:110px;border-radius:12px;object-fit:cover;
  box-shadow:0 10px 18px rgba(0,0,0,.22)
}

/* Layout */
.container{max-width:1180px;margin:18px auto 28px;padding:0 16px}
.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:0 8px 18px rgba(0,0,0,.08);
  margin-bottom:16px;
}
.card h2{margin:0 0 14px;font-size:1.35rem}

/* SETTINGS */
.settings-row{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.field{display:flex;align-items:center;gap:10px}
.field label{font-weight:900}
select{padding:7px 10px;border-radius:10px;border:1px solid #ddd;background:#fff}
.toggle{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;
}
.toggle input{transform:scale(1.05)}
.toggle strong{font-weight:900}
.reset-btn{
  margin-left:auto;border:0;padding:10px 16px;border-radius:12px;
  background:var(--danger);color:#fff;font-weight:900;cursor:pointer;
}
.reset-btn:active{transform:translateY(1px)}

/* Mannschaftsnamen */
.subhead{margin:14px 0 8px;font-weight:900}
.team-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(180px, 1fr));
  gap:12px;
}
.team-grid input{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:1rem;
}

/* Tables */
.table-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:760px}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:center;font-size:.95rem}
th{background:#eef3ff;font-weight:900}
.round{font-size:.8rem;color:var(--muted)}
.score-input{
  width:64px;padding:8px 8px;text-align:center;border-radius:12px;border:1px solid var(--line);font-size:1rem;
}
.winner-box{
  display:none;width:100%;padding:10px 12px;border-radius:12px;
  background:linear-gradient(90deg,var(--primary),var(--primary2));
  color:#fff;margin-bottom:10px;font-weight:900;
}
.leader-row{background:rgba(27,75,143,.12);font-weight:900}

/* kickoff */
.team-cell{display:flex;align-items:center;justify-content:center;gap:6px}
.kick{font-size:1rem}

/* Guided */
.guided-card{display:none}
.guided-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.guided-top .meta{color:var(--muted);font-weight:700}

/* im Hochformat nebeneinander */
.guided-vs{
  margin:10px 0 12px;
  display:flex;align-items:center;justify-content:center;gap:12px;
  flex-wrap:nowrap;
  white-space:nowrap;
  font-size:1.25rem;font-weight:900;
}
.guided-vs .team-cell{min-width:0}
.guided-vs .team-cell span, .guided-vs .team-cell{overflow:hidden;text-overflow:ellipsis}

/* Score */
.score-row{display:flex;align-items:center;justify-content:center;gap:14px;flex-wrap:wrap}
.score-col{display:flex;align-items:center;gap:10px}
.plus-ball{
  font-size:1.9rem;cursor:pointer;user-select:none;line-height:1;
  padding:6px 8px;border-radius:12px;background:#f3f6ff;border:1px solid var(--line);
}
.plus-ball:active{transform:scale(.97)}
.score-big{
  width:92px;padding:10px 10px;border-radius:14px;border:1px solid var(--line);
  font-size:1.5rem;text-align:center;
}

/* TIMER: Reset links, Anzeige Mitte, Minuten rechts; Start & Pause darunter */
.timer-wrap{
  display:grid;
  grid-template-columns: auto 1fr auto;
  grid-template-rows: auto auto;
  gap:10px;
  align-items:center;
  margin: 10px 0 6px;
}
.timer-reset{ grid-column:1; grid-row:1; justify-self:start; }
.timer-center{ grid-column:2; grid-row:1; justify-self:center; }
.timer-minutes{ grid-column:3; grid-row:1; justify-self:end; display:flex; align-items:center; gap:8px; }
.timer-actions{
  grid-column:2;
  grid-row:2;
  justify-self:center;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}

/* LED TIMER */
.timer-display{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-weight: 900;
  font-size: 3.2rem;
  letter-spacing: .08em;
  background: #0b0f14;
  color: #a8ffbf;
  border-radius: 16px;
  padding: 10px 18px;
  min-width: 190px;
  text-align: center;
  box-shadow: inset 0 0 18px rgba(0,0,0,.65), 0 8px 18px rgba(0,0,0,.18);
  text-shadow: 0 0 10px rgba(168,255,191,.35);
}
.timer-display.warn{
  color:#ffe08a;
  text-shadow: 0 0 12px rgba(255,224,138,.45);
  animation:pulseWarn 1.1s ease-in-out infinite;
}
.timer-display.end{
  color:#ff6b6b;
  text-shadow: 0 0 14px rgba(255,107,107,.55);
  animation:blinkEnd .55s steps(2,start) infinite;
}
@keyframes pulseWarn{50%{opacity:.6}}
@keyframes blinkEnd{to{visibility:hidden}}

.btn{
  border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;
  background:var(--primary);color:#fff;
}
.btn.light{background:#eef3ff;color:var(--primary)}
.btn.secondary{background:var(--primary2)}
.btn:disabled{opacity:.55;cursor:not-allowed}

/* Responsive */
@media (max-width:980px){
  .header-inner{flex-direction:column;text-align:center}
  .header-right{justify-content:center}
  .header-photo{width:260px;height:120px}
  .reset-btn{margin-left:0;width:100%}
  .team-grid{grid-template-columns:repeat(2, minmax(160px, 1fr))}
}
@media (max-width:520px){
  .team-grid{grid-template-columns:1fr}
  .header-center h1{font-size:1.35rem}
  table{min-width:680px}
  .timer-display{font-size:2.4rem;min-width:160px}
  .score-big{width:84px}
  .guided-vs{font-size:1.05rem}
  .btn{padding:10px 12px}
}

/* Guided-only: nur aktuelles Spiel */
body.guided-only header,
body.guided-only #settingsCard,
body.guided-only #scheduleCard,
body.guided-only #standingsCard{
  display:none !important;
}
body.guided-only .container{
  max-width:680px;
  margin:12px auto 18px;
}
</style>
</head>

<body>

<div id="intro">
  <img src="ball_intro_c3.png" alt="Intro Ball">
  <div id="introText">USV St. Marein U14<br>Turnier</div>
</div>

<div id="main">
  <header>
    <div class="header-inner">
      <div class="header-left">
        <div class="logo"><img src="logo.png" alt="Logo"></div>
      </div>

      <div class="header-center">
        <h1>USV St. Marein â€“ Interaktiver Turnierplan</h1>
        <p>3â€“6 Teams â€¢ Hin- & RÃ¼ckrunde â€¢ Live Tabelle</p>
      </div>

      <div class="header-right">
        <img src="foto1.png" class="header-photo" alt="Teamfoto">
      </div>
    </div>
  </header>

  <div class="container">

    <div class="card" id="settingsCard">
      <h2>Einstellungen</h2>

      <div class="settings-row">
        <div class="field">
          <label for="teamCount">Anzahl Teams</label>
          <select id="teamCount">
            <option value="3">3 Teams</option>
            <option value="4" selected>4 Teams</option>
            <option value="5">5 Teams</option>
            <option value="6">6 Teams</option>
          </select>
        </div>

        <label class="toggle" title="Wenn aktiv, wird nur das aktuelle Spiel angezeigt (sonst nichts)">
          <input type="checkbox" id="guidedToggle">
          <span><strong>GefÃ¼hrtes Turnier</strong> (nur aktuelles Spiel)</span>
        </label>

        <button class="reset-btn" id="resetBtn" type="button">Neues Turnier starten</button>
      </div>

      <div class="subhead">Mannschaftsnamen</div>
      <div id="teamInputs" class="team-grid"></div>
    </div>

    <div class="card guided-card" id="guidedCard">
      <div class="guided-top">
        <div style="font-weight:900;font-size:1.1rem">Aktuelles Spiel</div>
        <div class="meta" id="guidedMeta"></div>
      </div>

      <div class="timer-wrap">
        <div class="timer-reset">
          <button class="btn light" id="timerReset" type="button">Reset</button>
        </div>

        <div class="timer-center">
          <div class="timer-display" id="timerDisplay">10:00</div>
        </div>

        <div class="timer-minutes">
          <span style="font-weight:900;color:var(--muted)">Min</span>
          <input id="timerMinutes" type="number" min="1" step="1"
                 style="width:78px;padding:10px 10px;border-radius:12px;border:1px solid var(--line);text-align:center;font-weight:900"
                 value="10">
        </div>

        <div class="timer-actions">
          <button class="btn light" id="timerStart" type="button">Start</button>
          <button class="btn light" id="timerPause" type="button">Pause</button>
        </div>
      </div>

      <div class="guided-vs" id="guidedVs"></div>

      <div class="score-row">
        <div class="score-col">
          <span class="plus-ball" id="ballA" title="+1 Tor">âš½</span>
          <input class="score-big" type="number" inputmode="numeric" id="guidedScoreA" value="0">
        </div>

        <div style="font-weight:900;font-size:2rem;opacity:.75">:</div>

        <div class="score-col">
          <input class="score-big" type="number" inputmode="numeric" id="guidedScoreB" value="0">
          <span class="plus-ball" id="ballB" title="+1 Tor">âš½</span>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:14px">
        <button class="btn light" id="prevBtn" type="button">â—€ Vorheriges</button>
        <button class="btn secondary" id="nextBtn" type="button">NÃ¤chstes â–¶</button>
      </div>

      <div style="margin-top:10px;text-align:center">
        <button class="btn light" id="backToFull" type="button">â¬… ZurÃ¼ck zur Ãœbersicht</button>
      </div>
    </div>

    <div class="card" id="scheduleCard">
      <h2>Spielplan</h2>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Team A</th><th></th><th>Team B</th><th>Runde</th><th>A</th><th>B</th>
            </tr>
          </thead>
          <tbody id="matchesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="standingsCard">
      <h2>Tabelle</h2>
      <div id="winnerBox" class="winner-box"></div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>P</th><th>Team</th><th>Sp</th><th>S</th><th>U</th><th>N</th>
              <th>T+</th><th>T-</th><th>D</th><th>Pkt</th>
            </tr>
          </thead>
          <tbody id="standingsBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ========= MAIN SHOW AFTER INTRO ========= */
window.onload = () => {
  setTimeout(()=>{
    const m=document.getElementById("main");
    m.style.display="block";
    requestAnimationFrame(()=>m.style.opacity=1);
  },6000);
};

/* ========= STATE ========= */
const STORAGE_KEY="usv_turnier_guided_only_timer_v1";

let teamCount=4;
let teamNames=[];
let matches=[]; // {id,A,B,round,gA,gB,played}
let guidedMode=false;
let currentMatchIndex=0;

/* TIMER */
let audioCtx=null;
let timerInterval=null;
let timerRunning=false;
let timerDefaultMinutes=10;
let timerRemainingById={};     // matchId -> seconds
let warnedById={};             // matchId -> true (warn once)

/* ========= AUDIO ========= */
function initAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") audioCtx.resume();
}
function chirp(freq=1500,d=0.18,vol=0.6){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="sine";
  osc.frequency.value=freq;
  gain.gain.value=vol;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+d);
}
function warningSignal(){
  chirp(1550,.18,.55);
  setTimeout(()=>chirp(1550,.18,.55),220);
}
function whistle(duration=0.45,freq=1200){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="square";
  osc.frequency.value=freq;
  gain.gain.value=0.78; // LAUT
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+duration);
}
function finalWhistle(){
  whistle(0.45,1200);
  setTimeout(()=>whistle(0.45,1200),600);
}
function vibrateEnd(){ if("vibrate" in navigator) navigator.vibrate([300,150,300]); }
function vibrateWarn(){ if("vibrate" in navigator) navigator.vibrate(150); }

/* ========= TIMER ========= */
function fmt(sec){
  sec=Math.max(0, sec|0);
  const m=Math.floor(sec/60), s=sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function curMatch(){ return matches[currentMatchIndex] || null; }
function ensureTimer(matchId){
  if(timerRemainingById[matchId]==null){
    timerRemainingById[matchId]=timerDefaultMinutes*60;
  }
}
function clearTimerClasses(){
  const disp=document.getElementById("timerDisplay");
  if(disp) disp.classList.remove("warn","end");
}
function updateTimerUI(){
  const disp=document.getElementById("timerDisplay");
  const startBtn=document.getElementById("timerStart");
  const pauseBtn=document.getElementById("timerPause");
  const m=curMatch();
  if(!disp || !startBtn || !pauseBtn || !m) return;

  ensureTimer(m.id);
  disp.textContent=fmt(timerRemainingById[m.id]);

  startBtn.disabled = timerRunning;
  pauseBtn.disabled = !timerRunning;
}
function stopTimer(){
  timerRunning=false;
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  updateTimerUI();
  saveState();
}
function startTimer(){
  initAudio();
  if(timerRunning) return;
  const m=curMatch(); if(!m) return;

  ensureTimer(m.id);
  timerRunning=true;
  updateTimerUI();

  timerInterval=setInterval(()=>{
    const mm=curMatch(); if(!mm){ stopTimer(); return; }
    ensureTimer(mm.id);

    timerRemainingById[mm.id]=Math.max(0, timerRemainingById[mm.id]-1);
    updateTimerUI();

    if(timerRemainingById[mm.id]===60 && !warnedById[mm.id]){
      warnedById[mm.id]=true;
      const disp=document.getElementById("timerDisplay");
      if(disp){ disp.classList.add("warn"); disp.classList.remove("end"); }
      warningSignal();
      vibrateWarn();
    }

    if(timerRemainingById[mm.id]===0){
      stopTimer();
      const disp=document.getElementById("timerDisplay");
      if(disp){
        disp.classList.remove("warn");
        disp.classList.add("end");
      }
      finalWhistle();
      vibrateEnd();
    }

    saveState();
  },1000);

  saveState();
}
function resetTimerForCurrent(){
  const m=curMatch(); if(!m) return;
  ensureTimer(m.id);
  timerRemainingById[m.id]=timerDefaultMinutes*60;
  warnedById[m.id]=false;
  clearTimerClasses();
  stopTimer();
  updateTimerUI();
  saveState();
}

/* ========= STORAGE ========= */
function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      v:1,
      teamCount,
      teamNames,
      guidedMode,
      currentMatchIndex,
      timerDefaultMinutes,
      timerRemainingById,
      warnedById,
      matches: matches.map(m=>({
        id:m.id,A:m.A,B:m.B,round:m.round,
        gA:m.gA,gB:m.gB,played:!!m.played
      }))
    }));
  }catch(e){}
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const s=JSON.parse(raw);
    if(!s || s.v!==1) return null;

    if(typeof s.teamCount==="number") teamCount=s.teamCount;
    if(Array.isArray(s.teamNames)) teamNames=s.teamNames;

    // âœ… WICHTIG: IMMER NORMAL STARTEN (guided NICHT Ã¼bernehmen)
    guidedMode=false;

    if(Number.isInteger(s.currentMatchIndex)) currentMatchIndex=s.currentMatchIndex;

    if(Number.isInteger(s.timerDefaultMinutes) && s.timerDefaultMinutes>0) timerDefaultMinutes=s.timerDefaultMinutes;
    if(s.timerRemainingById && typeof s.timerRemainingById==="object") timerRemainingById=s.timerRemainingById;
    if(s.warnedById && typeof s.warnedById==="object") warnedById=s.warnedById;

    return s;
  }catch(e){ return null; }
}

/* ========= UI INIT ========= */
document.addEventListener("DOMContentLoaded",()=>{
  const loaded=loadState();

  const sel=document.getElementById("teamCount");
  const toggle=document.getElementById("guidedToggle");

  sel.value=String(teamCount);

  // âœ… immer aus beim Start
  guidedMode=false;
  toggle.checked=false;

  document.getElementById("timerMinutes").value=String(timerDefaultMinutes);

  document.getElementById("teamCount").addEventListener("change", ()=>{
    teamCount=parseInt(sel.value,10);
    teamNames=[];
    matches=[];
    currentMatchIndex=0;
    timerRemainingById={};
    warnedById={};
    clearTimerClasses();
    stopTimer();
    buildInputs();
    buildMatchesBerger(null);
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(confirm("Neues Turnier starten? Alle Ergebnisse gehen verloren.")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });

  toggle.addEventListener("change",(e)=>{
    guidedMode=!!e.target.checked;
    if(guidedMode){
      const idx=findFirstUnplayedIndex();
      if(idx!==-1) currentMatchIndex=idx;
    }
    clearTimerClasses();
    stopTimer();
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  document.getElementById("prevBtn").addEventListener("click", ()=>{
    if(currentMatchIndex>0){
      clearTimerClasses();
      stopTimer();
      currentMatchIndex--;
      renderGuidedMatch();
      saveState();
    }
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    if(currentMatchIndex<matches.length-1){
      clearTimerClasses();
      stopTimer();
      currentMatchIndex++;
      renderGuidedMatch();
      saveState();
    }
  });

  document.getElementById("guidedScoreA").addEventListener("input",(e)=>setGuidedScore("A", e.target.value));
  document.getElementById("guidedScoreB").addEventListener("input",(e)=>setGuidedScore("B", e.target.value));
  document.getElementById("ballA").addEventListener("click", ()=>incGuided("A"));
  document.getElementById("ballB").addEventListener("click", ()=>incGuided("B"));

  document.getElementById("timerStart").addEventListener("click", ()=>{
    if(!guidedMode) return;
    startTimer();
  });
  document.getElementById("timerPause").addEventListener("click", ()=>{
    if(!guidedMode) return;
    stopTimer();
  });
  document.getElementById("timerReset").addEventListener("click", ()=>{
    if(!guidedMode) return;
    resetTimerForCurrent();
  });

  document.getElementById("timerMinutes").addEventListener("change",(e)=>{
    const v=parseInt(e.target.value,10);
    if(Number.isFinite(v) && v>0){
      timerDefaultMinutes=v;
      saveState();
      updateTimerUI();
    }
  });

  document.getElementById("backToFull").addEventListener("click", ()=>{
    guidedMode = false;
    toggle.checked = false;
    clearTimerClasses();
    stopTimer();
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  buildInputs();
  buildMatchesBerger(loaded);
  applyModeUI();
  renderMatches();
  renderGuidedMatch();
  updateTable();
  updateTimerUI();
});

/* ========= TEAM INPUTS ========= */
function buildInputs(){
  const box=document.getElementById("teamInputs");
  box.innerHTML="";
  if(!Array.isArray(teamNames) || teamNames.length!==teamCount){
    teamNames=Array.from({length:teamCount},(_,i)=>"Team "+(i+1));
  }
  for(let i=0;i<teamCount;i++){
    const inp=document.createElement("input");
    inp.value=teamNames[i] || ("Team "+(i+1));
    inp.addEventListener("input", ()=>{
      teamNames[i]=inp.value.trim() || ("Team "+(i+1));
      renderMatches();
      renderGuidedMatch();
      updateTable();
      saveState();
    });
    box.appendChild(inp);
  }
}

/* ========= BERGER (Hin & RÃ¼ckrunde) ========= */
function buildMatchesBerger(loaded){
  matches=[];
  let indices=[...Array(teamCount).keys()];
  if(teamCount%2===1) indices.push(null);

  const n=indices.length, rounds=n-1;
  let arr=indices.slice(), roundsArr=[];

  for(let r=0;r<rounds;r++){
    let pairs=[];
    for(let i=0;i<n/2;i++){
      let t1=arr[i], t2=arr[n-1-i];
      if(t1!==null && t2!==null) pairs.push({A:t1,B:t2});
    }
    roundsArr.push(pairs);

    let fixed=arr[0];
    let rest=arr.slice(1);
    rest.unshift(rest.pop());
    arr=[fixed].concat(rest);
  }

  let id=1;
  for(let r=0;r<rounds;r++){
    roundsArr[r].forEach(p=>{
      matches.push({id:id++,A:p.A,B:p.B,round:"Hinrunde "+(r+1),gA:0,gB:0,played:false});
    });
  }
  for(let r=0;r<rounds;r++){
    roundsArr[r].forEach(p=>{
      matches.push({id:id++,A:p.B,B:p.A,round:"RÃ¼ckrunde "+(r+1),gA:0,gB:0,played:false});
    });
  }

  if(loaded && Array.isArray(loaded.matches)){
    const map=new Map(loaded.matches.map(x=>[x.id,x]));
    matches.forEach(m=>{
      const s=map.get(m.id);
      if(s){
        m.gA=Number.isFinite(s.gA)?s.gA:0;
        m.gB=Number.isFinite(s.gB)?s.gB:0;
        m.played=!!s.played;
      }
    });
  }

  currentMatchIndex=Math.max(0, Math.min(currentMatchIndex, matches.length-1));
}

/* ========= RENDER / MODE ========= */
function applyModeUI(){
  document.getElementById("guidedCard").style.display = guidedMode ? "block" : "none";
  document.getElementById("scheduleCard").style.display = guidedMode ? "none" : "block";
  document.body.classList.toggle("guided-only", guidedMode);
}
function teamName(i){ return teamNames[i] || ("Team "+(i+1)); }
function kickoffSide(m){ return String(m.round).startsWith("Hinrunde") ? "A" : "B"; }

function renderMatches(){
  const body=document.getElementById("matchesBody");
  body.innerHTML="";

  matches.forEach((m,i)=>{
    const kick=kickoffSide(m);
    const Aname=teamName(m.A), Bname=teamName(m.B);

    const tr=document.createElement("tr");

    const td0=document.createElement("td"); td0.textContent=i+1; tr.appendChild(td0);

    const tdA=document.createElement("td");
    tdA.innerHTML = (kick==="A")
      ? `<span class="team-cell"><span class="kick">âš½</span>${Aname}</span>`
      : Aname;
    tr.appendChild(tdA);

    const tdVs=document.createElement("td"); tdVs.textContent="vs"; tr.appendChild(tdVs);

    const tdB=document.createElement("td");
    tdB.innerHTML = (kick==="B")
      ? `<span class="team-cell"><span class="kick">âš½</span>${Bname}</span>`
      : Bname;
    tr.appendChild(tdB);

    const tdR=document.createElement("td");
    tdR.className="round";
    tdR.textContent=m.round;
    tr.appendChild(tdR);

    const tdSA=document.createElement("td");
    const inA=document.createElement("input");
    inA.type="number"; inA.inputMode="numeric";
    inA.className="score-input";
    inA.value=String(m.gA ?? 0);
    inA.addEventListener("input",(e)=>updateScore(m.id,"A",e.target.value));
    tdSA.appendChild(inA);
    tr.appendChild(tdSA);

    const tdSB=document.createElement("td");
    const inB=document.createElement("input");
    inB.type="number"; inB.inputMode="numeric";
    inB.className="score-input";
    inB.value=String(m.gB ?? 0);
    inB.addEventListener("input",(e)=>updateScore(m.id,"B",e.target.value));
    tdSB.appendChild(inB);
    tr.appendChild(tdSB);

    body.appendChild(tr);
  });
}

function renderGuidedMatch(){
  if(matches.length===0) return;

  currentMatchIndex=Math.max(0, Math.min(currentMatchIndex, matches.length-1));
  const m=matches[currentMatchIndex];
  const kick=kickoffSide(m);

  document.getElementById("guidedMeta").textContent =
    `Spiel ${currentMatchIndex+1} von ${matches.length} â€¢ ${m.round}`;

  const Aname=teamName(m.A), Bname=teamName(m.B);
  const Ahtml = (kick==="A")
    ? `<span class="team-cell"><span class="kick">âš½</span>${Aname}</span>`
    : `<span class="team-cell">${Aname}</span>`;
  const Bhtml = (kick==="B")
    ? `<span class="team-cell"><span class="kick">âš½</span>${Bname}</span>`
    : `<span class="team-cell">${Bname}</span>`;

  document.getElementById("guidedVs").innerHTML =
    `${Ahtml} <span style="opacity:.7">vs</span> ${Bhtml}`;

  document.getElementById("guidedScoreA").value = String(m.gA ?? 0);
  document.getElementById("guidedScoreB").value = String(m.gB ?? 0);

  document.getElementById("prevBtn").disabled = (currentMatchIndex===0);
  document.getElementById("nextBtn").disabled = (currentMatchIndex===matches.length-1);

  updateTimerUI();
}

/* ========= SCORE UPDATES ========= */
function updateScore(matchId, side, value){
  const m=matches.find(x=>x.id===matchId);
  if(!m) return;

  const v=(value===""?0:parseInt(value,10));
  if(side==="A") m.gA = Number.isFinite(v)?v:0;
  else m.gB = Number.isFinite(v)?v:0;

  m.played=true;

  if(curMatch() && curMatch().id===matchId) renderGuidedMatch();
  updateTable();
  saveState();
}

function setGuidedScore(side, value){
  const m=curMatch(); if(!m) return;
  const v=(value===""?0:parseInt(value,10));
  if(side==="A") m.gA = Number.isFinite(v)?v:0;
  else m.gB = Number.isFinite(v)?v:0;
  m.played=true;
  renderMatches();
  renderGuidedMatch();
  updateTable();
  saveState();
}

function incGuided(side){
  const el = (side==="A") ? document.getElementById("guidedScoreA") : document.getElementById("guidedScoreB");
  const next=(parseInt(el.value,10)||0)+1;
  el.value=String(next);
  el.dispatchEvent(new Event("input",{bubbles:true}));
}

function findFirstUnplayedIndex(){
  for(let i=0;i<matches.length;i++){
    if(!matches[i].played) return i;
  }
  return -1;
}

/* ========= TABLE ========= */
function updateTable(){
  const stats=Array.from({length:teamCount},(_,i)=>({
    name:teamName(i), sp:0,s:0,u:0,n:0,tPlus:0,tMinus:0,pkt:0
  }));

  matches.forEach(m=>{
    if(!m.played) return;
    const A=stats[m.A], B=stats[m.B];
    A.sp++; B.sp++;
    A.tPlus+=m.gA; A.tMinus+=m.gB;
    B.tPlus+=m.gB; B.tMinus+=m.gA;

    if(m.gA>m.gB){ A.s++; B.n++; A.pkt+=3; }
    else if(m.gA<m.gB){ B.s++; A.n++; B.pkt+=3; }
    else { A.u++; B.u++; A.pkt+=1; B.pkt+=1; }
  });

  stats.sort((a,b)=>
    b.pkt-a.pkt ||
    (b.tPlus-b.tMinus)-(a.tPlus-a.tMinus) ||
    b.tPlus-a.tPlus
  );

  const body=document.getElementById("standingsBody");
  const winner=document.getElementById("winnerBox");
  body.innerHTML="";
  let hasLeader=false;

  stats.forEach((s,i)=>{
    const tr=document.createElement("tr");
    if(i===0 && s.sp>0){
      tr.classList.add("leader-row");
      winner.style.display="block";
      winner.textContent=`ðŸ† FÃ¼hrender: ${s.name} â€“ ${s.pkt} Punkte, Diff ${s.tPlus-s.tMinus}`;
      hasLeader=true;
    }
    [i+1,s.name,s.sp,s.s,s.u,s.n,s.tPlus,s.tMinus,(s.tPlus-s.tMinus),s.pkt].forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });

  if(!hasLeader){
    winner.style.display="none";
    winner.textContent="";
  }
}
</script>
</body>
</html>
