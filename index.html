<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>USV St. Marein U14 ‚Äì Turnierplan</title>

<style>
:root{
  --bgTop:#061331;
  --bgMid:#0b2a6a;
  --bgBot:#041029;

  --card:#ffffff;
  --text:#1f2a37;
  --muted:#6b7280;
  --primary:#1b4b8f;
  --primary2:#2f6ed1;
  --danger:#c0392b;
  --line:#e5e7eb;

  --guidedCard:#f7f9ff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--text);
  min-height:100vh;
  background: linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 45%, var(--bgBot) 100%);
}
body::before{
  content:"";
  position:fixed;
  inset:-20%;
  pointer-events:none;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(47,110,209,.35) 0%, rgba(47,110,209,0) 60%),
    radial-gradient(900px 600px at 80% 30%, rgba(27,75,143,.25) 0%, rgba(27,75,143,0) 60%),
    radial-gradient(700px 500px at 50% 90%, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%);
  filter: blur(2px);
}

/* INTRO */
#intro{
  position:fixed; inset:0;
  background: linear-gradient(180deg, #04102a 0%, #0b2a6a 45%, #02091a 100%);
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  z-index:9999;
  animation:introFade 6s ease-out forwards;
}
#intro::before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 600px at 30% 25%, rgba(47,110,209,.35) 0%, rgba(47,110,209,0) 55%),
    radial-gradient(900px 600px at 70% 35%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 55%);
  pointer-events:none;
}
#intro img{
  position:relative;
  width:70%; max-width:420px;
  opacity:0;
  animation:ballIn 2.5s ease-out forwards .3s;
}
#introText{
  position:relative;
  margin-top:18px;
  color:#fff;
  font-size:2.0rem;
  font-weight:900;
  opacity:0;
  text-align:center;
  text-shadow:0 0 12px rgba(255,255,255,.55);
  animation:textIn 2.5s ease-out forwards 1.1s;
}
@keyframes ballIn{0%{opacity:0;transform:scale(.95)}100%{opacity:1;transform:scale(1)}}
@keyframes textIn{0%{opacity:0;transform:translateY(14px)}100%{opacity:1;transform:translateY(0)}}
@keyframes introFade{0%{opacity:1}100%{opacity:0;visibility:hidden}}
#main{opacity:0;display:none;transition:opacity 1.2s ease}

/* HEADER */
header{
  background:rgba(6,19,49,.55);
  backdrop-filter: blur(6px);
  color:#fff;
  padding:18px 16px;
  border-bottom: 1px solid rgba(255,255,255,.12);
}
.header-inner{
  max-width:1180px;margin:0 auto;
  display:flex;align-items:center;gap:18px;
}
.header-left{min-width:130px}
.logo{
  width:110px;height:110px;border-radius:50%;overflow:hidden;
  animation:logoGlowStrong 3s ease-in-out infinite;
}
.logo img{width:100%;height:100%;object-fit:cover;display:block}
@keyframes logoGlowStrong{
  0%,100%{
    box-shadow:
      0 0 0 3px rgba(255,255,255,.22),
      0 0 12px rgba(255,255,255,.18);
    filter:brightness(1);
  }
  50%{
    box-shadow:
      0 0 0 3px rgba(255,255,255,.28),
      0 0 26px rgba(255,255,255,.82);
    filter:brightness(1.08);
  }
}
.header-center{flex:1;text-align:center}
.header-center h1{margin:0;font-size:2.0rem;font-weight:900}
.header-center p{margin:8px 0 0;opacity:.95;font-size:1.0rem}
.header-right{min-width:240px;display:flex;justify-content:flex-end}
.header-photo{
  width:230px;height:110px;border-radius:12px;object-fit:cover;
  box-shadow:0 10px 18px rgba(0,0,0,.22)
}

/* Layout / Cards */
.container{max-width:1180px;margin:18px auto 28px;padding:0 16px; position:relative}
.card{
  background: rgba(255,255,255,.92);
  border-radius:14px;
  padding:18px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  margin-bottom:16px;
  border: 1px solid rgba(255,255,255,.25);
}
.card h2{margin:0 0 14px;font-size:1.35rem}

/* SETTINGS */
.settings-row{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.field-stack{display:flex;flex-direction:column;gap:10px;align-items:flex-start;}
.field-stack .toggle{margin:0;}

.field{display:flex;align-items:center;gap:10px}
.field label{font-weight:900}
.field-row{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap}
.field input[type="number"]{padding:7px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;min-width:110px;font-weight:900;text-align:center}

select{padding:7px 10px;border-radius:10px;border:1px solid #ddd;background:#fff}
.select-like{padding:7px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-weight:900;}
.btn.start{background:#22c55e;color:#06240f;}
.btn.start:hover{filter:brightness(.95);}
.btn.pause{background:#eef3ff;color:var(--primary);}
.btn.pause.pulsing{animation:pausePulse 1.1s ease-in-out infinite;}
@keyframes pausePulse{50%{transform:scale(1.03); filter:brightness(0.96);}}
.toggle{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;
}
.toggle input{transform:scale(1.05)}
.toggle strong{font-weight:900}
.reset-btn{
  margin-left:auto;border:0;padding:10px 16px;border-radius:12px;
  background:var(--danger);color:#fff;font-weight:900;cursor:pointer;
}
.reset-btn:active{transform:translateY(1px)}
.timer-setting{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fafafa;
}
.timer-setting input{
  width:84px; padding:10px 10px; border-radius:12px; border:1px solid var(--line);
  text-align:center; font-weight:900;
}

/* Mannschaftsnamen */
.subhead{margin:14px 0 8px;font-weight:900}
.team-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(180px, 1fr));
  gap:12px;
}
.team-grid input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:1rem;
}

/* Tables */
.table-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:760px}
th,td{padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);text-align:center;font-size:.95rem}
th{background:#eef3ff;font-weight:900}
.round{font-size:.8rem;color:var(--muted)}
.score-input{
  width:64px;padding:8px 8px;text-align:center;border-radius:12px;border:1px solid var(--line);font-size:1rem;
}
.winner-box{
  display:none;width:100%;padding:10px 12px;border-radius:12px;
  background:linear-gradient(90deg,var(--primary),var(--primary2));
  color:#fff;margin-bottom:10px;font-weight:900;
}
.leader-row{background:rgba(27,75,143,.10);font-weight:900}

/* kickoff */
.team-cell{display:flex;align-items:center;justify-content:center;gap:6px; min-width:0}
.kick{font-size:1rem}

/* Guided */
.guided-card{display:none; background: rgba(247,249,255,.92)}
.guided-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.guided-top .meta{color:var(--muted);font-weight:700}

/* Hochformat: Teams nebeneinander */
.guided-vs{
  margin:10px 0 12px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  gap:10px;
  font-size:1.25rem;
  font-weight:900;
}
/* Guided VS: keep teams on ONE line (even portrait) */
.guided-vs{display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px; width:100%; }
.guided-vs .team-cell{min-width:0; overflow:hidden; white-space:nowrap;}
.guided-vs .team-cell.left{justify-content:flex-end;}
.guided-vs .team-cell.right{justify-content:flex-start;}
.guided-vs .team-name{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;}

.guided-vs .team-cell{
  min-width:0;
  justify-content:center;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.guided-vs .team-cell{max-width:42vw; overflow:hidden; text-overflow:ellipsis}
.guided-vs .vs-mid{opacity:.7; font-weight:900}

/* Score */
.score-row{display:flex;align-items:center;justify-content:center;gap:14px;flex-wrap:wrap}
.score-col{display:flex;align-items:center;gap:10px}
.plus-ball{
  font-size:1.95rem;cursor:pointer;user-select:none;line-height:1;
  padding:8px 10px;border-radius:14px;background:#f3f6ff;border:1px solid var(--line);
}
.plus-ball:active{transform:scale(.97)}
.score-big{
  width:92px;padding:12px 10px;border-radius:14px;border:1px solid var(--line);
  font-size:1.6rem;text-align:center;font-weight:900;
}

/* TIMER Layout */
.timer-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:12px 0 10px;}
.timer-center{display:flex;justify-content:center;width:100%;}
.timer-actions{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;}
.timer-actions .btn{min-width:120px;}
.timer-actions .btn.start{min-width:160px;font-size:1.05rem;padding:14px 18px;}
.timer-actions .btn.small{min-width:110px;padding:12px 16px;font-size:0.98rem;}
/* LED TIMER */
.timer-display{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-weight: 900;
  font-size: 3.9rem;              /* gr√∂√üer */
  letter-spacing: .08em;
  background: #0b0f14;
  color: #a8ffbf;
  border-radius: 18px;
  padding: 12px 22px;
  min-width: 220px;
  text-align: center;
  box-shadow: inset 0 0 18px rgba(0,0,0,.65), 0 10px 22px rgba(0,0,0,.20);
  text-shadow: 0 0 12px rgba(168,255,191,.38);
}

.timer-display.warn{
  color:#ffe08a;
  text-shadow: 0 0 12px rgba(255,224,138,.45);
  animation:pulseWarn 1.1s ease-in-out infinite;
}
.timer-display.end{
  color:#ff6b6b;
  text-shadow: 0 0 14px rgba(255,107,107,.55);
  animation:blinkEnd .55s steps(2,start) infinite;
}
@keyframes pulseWarn{50%{opacity:.6}}
@keyframes blinkEnd{to{visibility:hidden}}

/* Buttons */
.btn{
  border:0;border-radius:14px;
  padding:12px 16px;
  font-weight:900;
  cursor:pointer;
  background:var(--primary);
  color:#fff;
}
.btn.light{background:#eef3ff;color:var(--primary)}
.btn.secondary{background:var(--primary2)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn.big{padding:14px 18px; font-size:1.05rem; min-width:132px}

/* Responsive */
@media (max-width:980px){
  .header-inner{flex-direction:column;text-align:center}
  .header-right{justify-content:center}
  .header-photo{width:260px;height:120px}
  .reset-btn{margin-left:0;width:100%}
  .team-grid{grid-template-columns:repeat(2, minmax(160px, 1fr))}
}
@media (max-width:520px){
  .field-row{flex-direction:column;align-items:stretch}
  .field input[type="number"], .field select{width:100%}

  .team-grid{grid-template-columns:1fr}
  .header-center h1{font-size:1.35rem}
  table{min-width:680px}
  .timer-display{font-size:3.1rem;min-width:190px}
  .score-big{width:86px}
  .guided-vs{font-size:1.05rem}
  .btn{padding:12px 14px}
  .btn.big{min-width:148px; padding:16px 18px; font-size:1.12rem}
}

/* Guided-only: nur aktuelles Spiel */
body.guided-only header,
body.guided-only #settingsCard,
body.guided-only #scheduleCard,
body.guided-only #standingsCard{ display:none !important; }
body.guided-only .container{ max-width:720px; margin:12px auto 18px; }
.pill{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);color:#fff}

/* Spielzeit gleiche Gr√∂√üe wie Auswahl Teams */
#timerMinutes{
  padding:7px 10px !important;
  border-radius:10px !important;
  border:1px solid #ddd !important;
  background:#fff !important;
  width:auto !important;
}

/* ===== Portrait Fix: Aktuelles Spiel (Teams + Spielst√§nde nebeneinander) ===== */
/* Teams (oben) immer in EINER Zeile, mit Ellipsis bei langen Namen */
#guidedVs{
  display:flex !important;
  flex-wrap:nowrap !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:8px !important;
  white-space:nowrap !important;
}
#guidedVs .team-cell{
  flex:1 1 0 !important;
  min-width:0 !important;
  justify-content:center !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}
#guidedVs .vs{
  flex:0 0 auto !important;
  opacity:.7 !important;
  font-weight:900 !important;
}

/* Spielst√§nde (unten) immer nebeneinander */
#guidedCard .score-row{
  flex-wrap:nowrap !important;
  gap:10px !important;
}
#guidedCard .score-col{flex:0 0 auto !important;}

@media (max-width:520px){
  #guidedVs{gap:6px !important;}
  #guidedCard .score-row{gap:8px !important;}
  #guidedCard .score-big{width:78px !important;}
  #guidedCard .plus-ball{font-size:1.7rem !important; padding:5px 7px !important;}
}


/* Hide extra settings */
.reset-btn{display:none !important;}

</style>
</head>

<body>

<div id="intro">
  <img src="ball_intro_c3.png" alt="Intro Ball">
  <div id="introText">USV St. Marein U14<br>Turnier</div>
</div>

<div id="main">
  <header>
    <div class="header-inner">
      <div class="header-left">
        <div class="logo"><img src="logo.png" alt="Logo"></div>
      </div>

      <div class="header-center">
        <h1>USV St. Marein ‚Äì Interaktiver Turnierplan</h1>
        <p>3‚Äì6 Teams ‚Ä¢ Hin- & R√ºckrunde ‚Ä¢ Live Tabelle</p>
      </div>

      <div class="header-right">
        <img src="foto1.png" class="header-photo" alt="Teamfoto">
      </div>
    </div>
  </header>

  <div class="container">

    <div class="card" id="settingsCard">
      <h2>Einstellungen</h2>

      <div class="settings-row">

        <div class="field-stack">
          <div class="field-row">
            <div class="field">
              <label for="teamCount">Anzahl Teams</label>
              <select id="teamCount">
            <option value="3">3 Teams</option>
            <option value="4" selected>4 Teams</option>
            <option value="5">5 Teams</option>
            <option value="6">6 Teams</option>
          </select>
            </div>
<div class="field">
              <label for="timerMinutes">Spielzeit (Min)</label>
              <select id="timerMinutes" class="select-like" style="width:110px;text-align:center">
  <option value="1">1 Min</option>
  <option value="2">2 Min</option>
  <option value="3">3 Min</option>
  <option value="4">4 Min</option>
  <option value="5">5 Min</option>
  <option value="6">6 Min</option>
  <option value="7">7 Min</option>
  <option value="8">8 Min</option>
  <option value="9">9 Min</option>
  <option value="10" selected>10 Min</option>
  <option value="11">11 Min</option>
  <option value="12">12 Min</option>
  <option value="13">13 Min</option>
  <option value="14">14 Min</option>
  <option value="15">15 Min</option>
  <option value="16">16 Min</option>
  <option value="17">17 Min</option>
  <option value="18">18 Min</option>
  <option value="19">19 Min</option>
  <option value="20">20 Min</option>
  <option value="21">21 Min</option>
  <option value="22">22 Min</option>
  <option value="23">23 Min</option>
  <option value="24">24 Min</option>
  <option value="25">25 Min</option>
  <option value="26">26 Min</option>
  <option value="27">27 Min</option>
  <option value="28">28 Min</option>
  <option value="29">29 Min</option>
  <option value="30">30 Min</option>
  <option value="31">31 Min</option>
  <option value="32">32 Min</option>
  <option value="33">33 Min</option>
  <option value="34">34 Min</option>
  <option value="35">35 Min</option>
  <option value="36">36 Min</option>
  <option value="37">37 Min</option>
  <option value="38">38 Min</option>
  <option value="39">39 Min</option>
  <option value="40">40 Min</option>
  <option value="41">41 Min</option>
  <option value="42">42 Min</option>
  <option value="43">43 Min</option>
  <option value="44">44 Min</option>
  <option value="45">45 Min</option>
  <option value="46">46 Min</option>
  <option value="47">47 Min</option>
  <option value="48">48 Min</option>
  <option value="49">49 Min</option>
  <option value="50">50 Min</option>
  <option value="51">51 Min</option>
  <option value="52">52 Min</option>
  <option value="53">53 Min</option>
  <option value="54">54 Min</option>
  <option value="55">55 Min</option>
  <option value="56">56 Min</option>
  <option value="57">57 Min</option>
  <option value="58">58 Min</option>
  <option value="59">59 Min</option>
  <option value="60">60 Min</option>
</select>
            </div>
          </div>

          <label class="toggle" title="Wenn aktiv, wird nur das aktuelle Spiel angezeigt (sonst nichts)">
          <input type="checkbox" id="guidedToggle">
          <span><strong>Gef√ºhrtes Turnier</strong> (nur aktuelles Spiel)</span>
        </label>
        </div>

        <button class="reset-btn" id="resetBtn" type="button">Neues Turnier starten</button>

</div>

      <div class="subhead">Mannschaftsnamen</div>
      <div id="teamInputs" class="team-grid"></div>
    </div>

    <div class="card guided-card" id="guidedCard">
      <div class="guided-top">
        <div style="font-weight:900;font-size:1.1rem">Aktuelles Spiel</div>
        <div class="meta" id="guidedMeta"></div>
      </div>

      <div class="timer-wrap">
        <div class="timer-center">
          <div class="timer-display" id="timerDisplay">10:00</div>
        </div>

        <div class="timer-actions">
          <button class="btn start" id="timerToggle" type="button">Start</button>
          <button class="btn light small" id="timerReset" type="button">Reset</button>
        </div>
      </div>

      <div class="guided-vs" id="guidedVs"></div>

      <div class="score-row">
        <div class="score-col">
          <span class="plus-ball" id="ballA" title="+1 Tor">‚öΩ</span>
          <input class="score-big" type="number" inputmode="numeric" id="guidedScoreA" value="0">
        </div>

        <div style="font-weight:900;font-size:2rem;opacity:.75">:</div>

        <div class="score-col">
          <input class="score-big" type="number" inputmode="numeric" id="guidedScoreB" value="0">
          <span class="plus-ball" id="ballB" title="+1 Tor">‚öΩ</span>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:14px">
        <button class="btn light" id="prevBtn" type="button">‚óÄ Vorheriges</button>
        <button class="btn secondary" id="nextBtn" type="button">N√§chstes ‚ñ∂</button>
      </div>

      <div style="margin-top:10px;text-align:center">
        <button class="btn light" id="backToFull" type="button">‚¨Ö Zur√ºck zur √úbersicht</button>
      </div>
    </div>

    <div class="card" id="scheduleCard">
      <h2>Spielplan</h2>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Team A</th><th></th><th>Team B</th><th>Runde</th><th>A</th><th>B</th>
            </tr>
          </thead>
          <tbody id="matchesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="standingsCard">
      <h2>Tabelle</h2>
      <div id="winnerBox" class="winner-box"></div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>P</th><th>Team</th><th>Sp</th><th>S</th><th>U</th><th>N</th>
              <th>T+</th><th>T-</th><th>D</th><th>Pkt</th>
            </tr>
          </thead>
          <tbody id="standingsBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
window.onload = () => {
  setTimeout(()=>{
    const m=document.getElementById("main");
    m.style.display="block";
    requestAnimationFrame(()=>m.style.opacity=1);
  },6000);
};

const STORAGE_KEY="usv_turnier_final_full_v3_timer_settings";
let teamCount=4;
let teamNames=[];
let matches=[];
let guidedMode=false;
let currentMatchIndex=0;

let audioCtx=null;
let timerInterval=null;
let timerRunning=false;
let timerDefaultMinutes=10;
let timerRemainingById={};
let warnedById={};
let timerEndAtById={}; // matchId -> ms timestamp when running

let lastTickMs=0;

let wakeLock=null;

function initAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") audioCtx.resume();
}
function chirp(freq=1650,d=0.18,vol=0.6){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="sine";
  osc.frequency.value=freq;
  gain.gain.value=vol;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+d);
}
function warningSignal(){
  chirp(1650,.18,.55);
  setTimeout(()=>chirp(1650,.18,.55),220);
}
function whistle(duration=0.45,freq=1200){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="square";
  osc.frequency.value=freq;
  gain.gain.value=0.80;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+duration);
}
function finalWhistle(){
  whistle(0.45,1200);
  setTimeout(()=>whistle(0.45,1200),600);
}
function vibrateEnd(){ if("vibrate" in navigator) navigator.vibrate([300,150,300]); }
function vibrateWarn(){ if("vibrate" in navigator) navigator.vibrate(150); }

function fmt(sec){
  sec=Math.max(0, sec|0);
  const m=Math.floor(sec/60), s=sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function curMatch(){ return matches[currentMatchIndex] || null; }
function ensureTimer(matchId){
  if(timerRemainingById[matchId]==null){
    timerRemainingById[matchId]=timerDefaultMinutes*60;
  }
}
function clearTimerClasses(){
  const disp=document.getElementById("timerDisplay");
  if(disp) disp.classList.remove("warn","end");
}
function updateTimerUI(){
  const disp=document.getElementById("timerDisplay");
  const toggle=document.getElementById("timerToggle");
  const reset=document.getElementById("timerReset");
  const m=curMatch();
  if(!disp || !toggle || !reset || !m) return;

  ensureTimer(m.id);
  disp.textContent=fmt(timerRemainingById[m.id]);

  if(timerRunning){
    toggle.textContent="Pause";
    toggle.classList.remove("start");
    toggle.classList.add("pause","pulsing");
  }else{
    toggle.textContent="Start";
    toggle.classList.remove("pause","pulsing");
    toggle.classList.add("start");
  }
}

function applyElapsed(){
  if(!timerRunning) return;
  const m=curMatch(); if(!m) return;
  ensureTimer(m.id);

  const now=performance.now();
  if(!lastTickMs) lastTickMs=now;

  const elapsedSec = Math.floor((now - lastTickMs)/1000);
  if(elapsedSec <= 0) return;

  lastTickMs += elapsedSec*1000;
  timerRemainingById[m.id]=Math.max(0, timerRemainingById[m.id]-elapsedSec);

  if(timerRemainingById[m.id] <= 60 && timerRemainingById[m.id] > 0){
    const disp=document.getElementById("timerDisplay");
    if(disp){ disp.classList.add("warn"); disp.classList.remove("end"); }
    if(timerRemainingById[m.id] === 60 && !warnedById[m.id]){
      warnedById[m.id]=true;
      initAudio();
      warningSignal();
      vibrateWarn();
    }
  }

  if(timerRemainingById[m.id] === 0){
    stopTimer(true);
    const disp=document.getElementById("timerDisplay");
    if(disp){
      disp.classList.remove("warn");
      disp.classList.add("end");
    }
    m.played = true;
    updateTable();
    saveState();

    initAudio();
    finalWhistle();
    vibrateEnd();
  }

  updateTimerUI();
}

function stopTimer(keepWake=false){
  timerRunning=false;
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  lastTickMs=0;
  updateTimerUI();
  saveState();
  if(!keepWake) releaseWakeLock();
}
function startTimer(){
  initAudio();
  if(timerRunning) return;
  const m=curMatch(); if(!m) return;

  ensureTimer(m.id);
  timerRunning=true;
  lastTickMs=performance.now();

  clearTimerClasses();
  if(timerRemainingById[m.id] <= 60 && timerRemainingById[m.id] > 0){
    const disp=document.getElementById("timerDisplay");
    if(disp) disp.classList.add("warn");
  }
  if(timerRemainingById[m.id] === 0){
    const disp=document.getElementById("timerDisplay");
    if(disp) disp.classList.add("end");
  }

  updateTimerUI();
  requestWakeLock();

  timerInterval=setInterval(()=>{
    applyElapsed();
    saveState();
  }, 250);

  saveState();
}
function resetTimerForCurrent(){
  const m=curMatch(); if(!m) return;
  ensureTimer(m.id);
  timerRemainingById[m.id]=timerDefaultMinutes*60;
  warnedById[m.id]=false;
  clearTimerClasses();
  stopTimer();
  updateTimerUI();
  saveState();
}

async function requestWakeLock(){
  try{
    if(!("wakeLock" in navigator)) return;
    wakeLock = await navigator.wakeLock.request("screen");
    if(pill){ pill.style.display="inline-block"; }
    wakeLock.addEventListener("release", ()=>{
      if(pill2){ pill2.style.display="none"; }
      wakeLock=null;
    });
  }catch(e){}
}
async function releaseWakeLock(){
  try{ if(wakeLock){ await wakeLock.release(); } }catch(e){}
  wakeLock=null;
  if(pill){ pill.style.display="none"; }
}

document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState === "visible"){
    applyElapsed();
    if(guidedMode && timerRunning) requestWakeLock();
  }
});

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      v:3,
      teamCount,
      teamNames,
      guidedMode,
      currentMatchIndex,
      timerDefaultMinutes,
      timerRemainingById,
      warnedById,
      matches: matches.map(m=>({
        id:m.id,A:m.A,B:m.B,round:m.round,
        gA:m.gA,gB:m.gB,played:!!m.played
      }))
    }));
  }catch(e){}
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const s=JSON.parse(raw);
    if(!s || (s.v!==3 && s.v!==2 && s.v!==1)) return null;

    if(typeof s.teamCount==="number") teamCount=s.teamCount;
    if(Array.isArray(s.teamNames)) teamNames=s.teamNames;

    guidedMode=false;

    if(Number.isInteger(s.currentMatchIndex)) currentMatchIndex=s.currentMatchIndex;

    if(Number.isInteger(s.timerDefaultMinutes) && s.timerDefaultMinutes>0) timerDefaultMinutes=s.timerDefaultMinutes;
    if(s.timerRemainingById && typeof s.timerRemainingById==="object") timerRemainingById=s.timerRemainingById;
    if(s.warnedById && typeof s.warnedById==="object") warnedById=s.warnedById;

    return s;
  }catch(e){ return null; }
}

document.addEventListener("DOMContentLoaded",()=>{
  const loaded=loadState();

  const sel=document.getElementById("teamCount");
  const toggle=document.getElementById("guidedToggle");
  const timerMinEl=document.getElementById("timerMinutes");

  sel.value=String(teamCount);

  guidedMode=false;
  toggle.checked=false;

  timerMinEl.value=String(timerDefaultMinutes);

// Ensure timerMinutes dropdown contains the stored/default value (in case it's not in the list)
(function ensureTimerOption(){
  const el = document.getElementById("timerMinutes");
  if(!el || el.tagName !== "SELECT") return;
  const v = String(timerDefaultMinutes);
  if([...el.options].some(o => o.value === v)) return;
  const opt = document.createElement("option");
  opt.value = v;
  opt.textContent = v + " Min";
  el.appendChild(opt);
})();


  sel.addEventListener("change", ()=>{
    teamCount=parseInt(sel.value,10);
    teamNames=[];
    matches=[];
    currentMatchIndex=0;
    timerRemainingById={};
    warnedById={};
    clearTimerClasses();
    stopTimer();
    buildInputs();
    buildMatchesBerger(null);
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(confirm("Neues Turnier starten? Alle Ergebnisse gehen verloren.")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });

  toggle.addEventListener("change",(e)=>{
    guidedMode=!!e.target.checked;
    if(guidedMode){
      const idx=findFirstUnplayedIndex();
      if(idx!==-1) currentMatchIndex=idx;
    }
    clearTimerClasses();
    stopTimer();
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  document.getElementById("prevBtn").addEventListener("click", ()=>{
    if(currentMatchIndex>0){
      clearTimerClasses();
      stopTimer();
      currentMatchIndex--;
      renderGuidedMatch();
      saveState();
    }
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    if(currentMatchIndex<matches.length-1){
      clearTimerClasses();
      stopTimer();
      currentMatchIndex++;
      renderGuidedMatch();
      saveState();
    }
  });

  document.getElementById("guidedScoreA").addEventListener("input",(e)=>setGuidedScore("A", e.target.value));
  document.getElementById("guidedScoreB").addEventListener("input",(e)=>setGuidedScore("B", e.target.value));
  document.getElementById("ballA").addEventListener("click", ()=>incGuided("A"));
  document.getElementById("ballB").addEventListener("click", ()=>incGuided("B"));

  document.getElementById("timerToggle").addEventListener("click", ()=>{
    if(!guidedMode) return;
    if(timerRunning) stopTimer(); else startTimer();
  });
  document.getElementById("timerReset").addEventListener("click", ()=>{
    if(!guidedMode) return;
    resetTimerForCurrent();
  });

  timerMinEl.addEventListener("change",(e)=>{
    const v=parseInt(e.target.value,10);
    if(!Number.isFinite(v) || v<=0) return;

    // Wenn bereits Timer-Werte initialisiert wurden (z. B. durch UI-Render),
    // sollen "unver√§nderte" Zeiten trotzdem auf die neue Spielzeit umgestellt werden.
    const oldDefault = timerDefaultMinutes;
    timerDefaultMinutes = v;

    const oldSec = oldDefault * 60;
    const newSec = timerDefaultMinutes * 60;
    const runningId = (timerRunning && curMatch()) ? curMatch().id : null;

    for(const mm of matches){
      if(!mm) continue;
      if(runningId === mm.id) continue; // laufenden Timer nicht anfassen

      const cur = timerRemainingById[mm.id];
      // Update nur wenn noch nicht gesetzt ODER noch exakt auf der alten Standardzeit steht
      if(cur == null || cur === oldSec){
        timerRemainingById[mm.id] = newSec;
        warnedById[mm.id] = false;
      }
    }

    clearTimerClasses();
    saveState();
    updateTimerUI();
  });

  document.getElementById("backToFull").addEventListener("click", ()=>{
    guidedMode=false;
    toggle.checked=false;
    clearTimerClasses();
    stopTimer();
    applyModeUI();
    renderMatches();
    renderGuidedMatch();
    updateTable();
    saveState();
  });

  buildInputs();
  buildMatchesBerger(loaded);
  applyModeUI();
  renderMatches();
  renderGuidedMatch();
  updateTable();
  updateTimerUI();
});

function buildInputs(){
  const box=document.getElementById("teamInputs");
  box.innerHTML="";
  if(!Array.isArray(teamNames) || teamNames.length!==teamCount){
    teamNames=Array.from({length:teamCount},(_,i)=>"Team "+(i+1));
  }
  for(let i=0;i<teamCount;i++){
    const inp=document.createElement("input");
    inp.value=teamNames[i] || ("Team "+(i+1));
    inp.addEventListener("input", ()=>{
      teamNames[i]=inp.value.trim() || ("Team "+(i+1));
      renderMatches();
      renderGuidedMatch();
      updateTable();
      saveState();
    });
    box.appendChild(inp);
  }
}

function buildMatchesBerger(loaded){
  matches=[];
  let indices=[...Array(teamCount).keys()];
  if(teamCount%2===1) indices.push(null);

  const n=indices.length, rounds=n-1;
  let arr=indices.slice(), roundsArr=[];

  for(let r=0;r<rounds;r++){
    let pairs=[];
    for(let i=0;i<n/2;i++){
      let t1=arr[i], t2=arr[n-1-i];
      if(t1!==null && t2!==null) pairs.push({A:t1,B:t2});
    }
    roundsArr.push(pairs);

    let fixed=arr[0];
    let rest=arr.slice(1);
    rest.unshift(rest.pop());
    arr=[fixed].concat(rest);
  }

  let id=1;
  for(let r=0;r<rounds;r++){
    roundsArr[r].forEach(p=>{
      matches.push({id:id++,A:p.A,B:p.B,round:"Hinrunde "+(r+1),gA:0,gB:0,played:false});
    });
  }
  for(let r=0;r<rounds;r++){
    roundsArr[r].forEach(p=>{
      matches.push({id:id++,A:p.B,B:p.A,round:"R√ºckrunde "+(r+1),gA:0,gB:0,played:false});
    });
  }

  if(loaded && Array.isArray(loaded.matches)){
    const map=new Map(loaded.matches.map(x=>[x.id,x]));
    matches.forEach(m=>{
      const s=map.get(m.id);
      if(s){
        m.gA=Number.isFinite(s.gA)?s.gA:0;
        m.gB=Number.isFinite(s.gB)?s.gB:0;
        m.played=!!s.played;
      }
    });
  }

  currentMatchIndex=Math.max(0, Math.min(currentMatchIndex, matches.length-1));
}

function applyModeUI(){
  document.getElementById("guidedCard").style.display = guidedMode ? "block" : "none";
  document.getElementById("scheduleCard").style.display = guidedMode ? "none" : "block";
  document.body.classList.toggle("guided-only", guidedMode);
}
function teamName(i){ return teamNames[i] || ("Team "+(i+1)); }
function kickoffSide(m){ return String(m.round).startsWith("Hinrunde") ? "A" : "B"; }

function renderMatches(){
  const body=document.getElementById("matchesBody");
  body.innerHTML="";

  matches.forEach((m,i)=>{
    const kick=kickoffSide(m);
    const Aname=teamName(m.A), Bname=teamName(m.B);

    const tr=document.createElement("tr");

    const td0=document.createElement("td"); td0.textContent=i+1; tr.appendChild(td0);

    const tdA=document.createElement("td");
    tdA.innerHTML = (kick==="A")
      ? `<span class="team-cell"><span class="kick">‚öΩ</span>${escapeHtml(Aname)}</span>`
      : escapeHtml(Aname);
    tr.appendChild(tdA);

    const tdVs=document.createElement("td"); tdVs.textContent="vs"; tr.appendChild(tdVs);

    const tdB=document.createElement("td");
    tdB.innerHTML = (kick==="B")
      ? `<span class="team-cell"><span class="kick">‚öΩ</span>${escapeHtml(Bname)}</span>`
      : escapeHtml(Bname);
    tr.appendChild(tdB);

    const tdR=document.createElement("td");
    tdR.className="round";
    tdR.textContent=m.round;
    tr.appendChild(tdR);

    const tdSA=document.createElement("td");
    const inA=document.createElement("input");
    inA.type="number"; inA.inputMode="numeric";
    inA.className="score-input";
    inA.value=String(m.gA ?? 0);
    inA.addEventListener("input",(e)=>updateScore(m.id,"A",e.target.value));
    tdSA.appendChild(inA);
    tr.appendChild(tdSA);

    const tdSB=document.createElement("td");
    const inB=document.createElement("input");
    inB.type="number"; inB.inputMode="numeric";
    inB.className="score-input";
    inB.value=String(m.gB ?? 0);
    inB.addEventListener("input",(e)=>updateScore(m.id,"B",e.target.value));
    tdSB.appendChild(inB);
    tr.appendChild(tdSB);

    body.appendChild(tr);
  });
}

function renderGuidedMatch(){
  if(matches.length===0) return;

  currentMatchIndex=Math.max(0, Math.min(currentMatchIndex, matches.length-1));
  const m=matches[currentMatchIndex];
  const kick=kickoffSide(m);

  document.getElementById("guidedMeta").textContent =
    `Spiel ${currentMatchIndex+1} von ${matches.length} ‚Ä¢ ${m.round}`;

  const Aname=teamName(m.A), Bname=teamName(m.B);
  const Ahtml = (kick==="A")
    ? `<span class="team-cell left"><span class="kick">‚öΩ</span><span class="team-name">${escapeHtml(Aname)}</span></span>`
    : `<span class="team-cell left"><span class="team-name">${escapeHtml(Aname)}</span></span>`;
  const Bhtml = (kick==="B")
    ? `<span class="team-cell right"><span class="kick">‚öΩ</span><span class="team-name">${escapeHtml(Bname)}</span></span>`
    : `<span class="team-cell right"><span class="team-name">${escapeHtml(Bname)}</span></span>`;

  document.getElementById("guidedVs").innerHTML =
    `${Ahtml} <span class="vs-mid">vs</span> ${Bhtml}`;

  document.getElementById("guidedScoreA").value = String(m.gA ?? 0);
  document.getElementById("guidedScoreB").value = String(m.gB ?? 0);

  document.getElementById("prevBtn").disabled = (currentMatchIndex===0);
  document.getElementById("nextBtn").disabled = (currentMatchIndex===matches.length-1);

  ensureTimer(m.id);
  updateTimerUI();
}

function updateScore(matchId, side, value){
  const m=matches.find(x=>x.id===matchId);
  if(!m) return;

  const v=(value===""?0:parseInt(value,10));
  if(side==="A") m.gA = Number.isFinite(v)?v:0;
  else m.gB = Number.isFinite(v)?v:0;

  m.played=true;

  if(curMatch() && curMatch().id===matchId) renderGuidedMatch();
  updateTable();
  saveState();
}

function setGuidedScore(side, value){
  const m=curMatch(); if(!m) return;
  const v=(value===""?0:parseInt(value,10));
  if(side==="A") m.gA = Number.isFinite(v)?v:0;
  else m.gB = Number.isFinite(v)?v:0;
  m.played=true;
  renderMatches();
  renderGuidedMatch();
  updateTable();
  saveState();
}

function incGuided(side){
  const el = (side==="A") ? document.getElementById("guidedScoreA") : document.getElementById("guidedScoreB");
  const next=(parseInt(el.value,10)||0)+1;
  el.value=String(next);
  el.dispatchEvent(new Event("input",{bubbles:true}));
}

function findFirstUnplayedIndex(){
  for(let i=0;i<matches.length;i++){
    if(!matches[i].played) return i;
  }
  return -1;
}

function updateTable(){
  const stats=Array.from({length:teamCount},(_,i)=>({
    name:teamName(i), sp:0,s:0,u:0,n:0,tPlus:0,tMinus:0,pkt:0
  }));

  matches.forEach(m=>{
    if(!m.played) return;
    const A=stats[m.A], B=stats[m.B];
    A.sp++; B.sp++;
    A.tPlus+=m.gA; A.tMinus+=m.gB;
    B.tPlus+=m.gB; B.tMinus+=m.gA;

    if(m.gA>m.gB){ A.s++; B.n++; A.pkt+=3; }
    else if(m.gA<m.gB){ B.s++; A.n++; B.pkt+=3; }
    else { A.u++; B.u++; A.pkt+=1; B.pkt+=1; }
  });

  stats.sort((a,b)=>
    b.pkt-a.pkt ||
    (b.tPlus-b.tMinus)-(a.tPlus-a.tMinus) ||
    b.tPlus-a.tPlus
  );

  const body=document.getElementById("standingsBody");
  const winner=document.getElementById("winnerBox");
  body.innerHTML="";
  let hasLeader=false;

  stats.forEach((s,i)=>{
    const tr=document.createElement("tr");
    if(i===0 && s.sp>0){
      tr.classList.add("leader-row");
      winner.style.display="block";
      winner.textContent=`üèÜ F√ºhrender: ${s.name} ‚Äì ${s.pkt} Punkte, Diff ${s.tPlus-s.tMinus}`;
      hasLeader=true;
    }
    [i+1,s.name,s.sp,s.s,s.u,s.n,s.tPlus,s.tMinus,(s.tPlus-s.tMinus),s.pkt].forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });

  if(!hasLeader){
    winner.style.display="none";
    winner.textContent="";
  }
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Auto-place Spielzeit field right next to Anzahl Teams
document.addEventListener('DOMContentLoaded', ()=>{
  const tc = document.getElementById('teamCount');
  const tm = document.getElementById('timerMinutes');
  if(tc && tm){
    const f1 = tc.closest('.field');
    const f2 = tm.closest('.field');
    if(f1 && f2 && f1.parentElement === f2.parentElement){
      f1.parentElement.insertBefore(f2, f1.nextSibling);
    }
  }
});

</script>
</body>
</html>
